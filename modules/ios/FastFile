# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools

default_platform(:ios)

# See https://docs.fastlane.tools/actions/deliver for details.
supported_languages = [
  "ar-SA", "ca", "cs", "da", "de-DE", "el", "en-AU", "en-CA", "en-GB", "en-US",
  "es-ES", "es-MX", "fi", "fr-CA", "fr-FR", "he", "hi", "hr", "hu", "id", "it",
  "ja", "ko", "ms", "nl-NL", "no", "pl", "pt-BR", "pt-PT", "ro", "ru", "sk", "sv",
  "th", "tr", "uk", "vi", "zh-Hans", "zh-Hant"
]

platform :ios do
  desc "Build and upload to TestFlight"
  lane :deploy do |options|
    version_name = options[:version_name]
    build_number = options[:build_number]
    release_note = options[:release_note]
    release_note_language = options[:release_note_language]
    skip_wait_processing = options[:skip_wait_processing]
    bundle_identifier = options[:bundle_identifier]
    build_extra = options[:build_extra]
    build_dest_path = options[:build_dest_path]
    ios_dir = File.expand_path("../", __dir__)

    # Determine whether to automatically distribute to external testers
    auto_distribute_external = !release_note.nil? && release_note.strip != ""

    if auto_distribute_external
      puts "ğŸ“¤ Automatic external distribution enabled based on provided release notes."
      release_note = release_note.gsub("\\n", "\n")

      # If not supported, set the language code to abbreviation.
      release_note_language = (
        supported_languages.include?(release_note_language) ?
        release_note_language :
        release_note_language.split("-")[0]
      )
    end

    begin
      # Create a temporary keychain for signing
      setup_ci

      # App Store Connect API key
      api_key = app_store_connect_api_key(
        key_id: ENV["APPSTORE_CONNECT_KEY_ID"],
        key_content: ENV["APPSTORE_CONNECT_KEY"],
        issuer_id: ENV["APPSTORE_CONNECT_ISSUER_ID"],
        in_house: false
      )

      # Fetch distribution certificates and provisioning profiles
      match(
        type: "appstore",
        api_key: api_key,
      )

      # Provisioning profile UUID
      profile_uuid = ENV["sigh_#{bundle_identifier}_appstore"]

      # Disable automatic code signing in Xcode project
      update_code_signing_settings(
        use_automatic_signing: false,                         # Whether to use automatic signing
        path: "#{ios_dir}/Runner.xcodeproj",                  # Xcode project path
        team_id: options[:appstore_team_id],                  # Team ID
        profile_uuid: profile_uuid,                           # Provisioning profile UUID
        code_sign_identity: "Apple Distribution"              # Certificate type
      )

      # Prepare ExportOptions.plist by replacing placeholders with actual values
      template_option_path = File.expand_path("ExportOptions.plist", __dir__)
      modified_option_path = File.expand_path("ModifiedExportOptions.plist", __dir__)

      plist_content = File.read(template_option_path)
      plist_content.gsub!("{app_bundle_id}", bundle_identifier)
      plist_content.gsub!("{provisioning_profile_uuid}", profile_uuid)
      File.write(modified_option_path, plist_content)

      command = [
        "flutter build ipa --release",
        "--build-name=#{version_name}",
        "--build-number=#{build_number}",
        "--export-options-plist #{modified_option_path}",
        build_extra
      ].compact.join(" ").strip

      # Build the iOS app
      sh(command)

      # The absolute path where the built iOS App File (IPA) will be saved.
      # The path is resolved relative to this `fastfile/` directory.
      output_path = Dir.glob(File.expand_path("../../build/ios/ipa/**/*.ipa", __dir__)).first

      # Determine the Flutter project root directory.
      flutter_root = File.expand_path("../..", __dir__)

      # Resolve the destination path for the AAB relative to the Flutter root.
      dest_path = File.expand_path(build_dest_path, flutter_root)

      # Ensure the destination directory exists, then copy the AAB file there.
      require 'fileutils'
      FileUtils.mkdir_p(File.dirname(dest_path))
      FileUtils.cp(output_path, dest_path)

      # Upload the build to TestFlight
      upload_params = {
        ipa: output_path,
        api_key: api_key,
        skip_waiting_for_build_processing: skip_wait_processing,
        # Explicitly set app version to prevent automatic normalization (e.g., 1.0 -> 1.0.0)
        app_version: version_name,
      }

      # If release notes are provided, automatically distribute to external testers
      if auto_distribute_external
        upload_params[:distribute_external] = true
        upload_params[:beta_app_description] = {release_note_language => release_note}
        puts "ğŸš€ Will automatically distribute to external testers with release notes."
      else
        upload_params[:distribute_external] = false
        puts "ğŸ“¦ Uploading to TestFlight (internal only)."
      end

      upload_to_testflight(upload_params)
    end
  end
end
